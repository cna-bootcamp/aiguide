"""Customer Experience Agent - 고객 경험 인터뷰, 관찰, 체험 결과 생성."""

from typing import Dict, Any
from .base_agent import BaseAgent


class CustomerExperienceAgent(BaseAgent):
    """
    고객 경험 인터뷰, 관찰, 체험 결과를 생성하는 에이전트
    Journey Map 작성 전에 실행되어 고객의 실제 경험 데이터를 수집합니다.
    """

    def __init__(self):
        super().__init__(
            name="고객 경험 에이전트",
            description="고객 인터뷰, 관찰, 체험을 통해 고객 경험 데이터를 생성합니다."
        )

    def get_prompt_template(self, context: Dict[str, Any]) -> str:
        mvp_topic = context.get("mvp_topic", "")
        target_customer = context.get("target_customer", "")
        market_research = context.get("market_research", "")

        return f"""당신은 고객 경험(CX) 리서치 전문가입니다.
대상 고객의 실제 경험을 파악하기 위한 종합적인 고객 경험 조사를 수행해주세요.

MVP 주제: {mvp_topic}
대상 고객: {target_customer}
시장 조사 결과: {market_research if market_research else "시장 조사 데이터 없음"}

다음 3가지 조사 방법을 모두 활용하여 고객 경험 데이터를 생성해주세요:

---

# 1. 고객 경험 인터뷰 결과

## 인터뷰 개요
- **조사 목적**: [인터뷰 목적]
- **조사 기간**: [기간]
- **조사 대상**: [대상 고객군]
- **조사 방법**: 1:1 심층 인터뷰

## 인터뷰 일정

| 인터뷰 일시 | 인터뷰 장소 | 인터뷰어 | 고객명 | 고객 프로필 |
|------------|------------|---------|--------|------------|
| [일시] | [장소] | [인터뷰어] | [가명] | [나이대, 직업, 특성] |
| [5-10명 정도의 인터뷰 대상자 나열] |

## 인터뷰 질문 및 응답

### 고객 1: [이름]

**Q1. [현재 상황/문제 관련 질문]**
- A: [고객 응답]

**Q2. [기존 해결 방법 관련 질문]**
- A: [고객 응답]

**Q3. [불편사항/Pain Point 질문]**
- A: [고객 응답]

**Q4. [이상적인 해결책 질문]**
- A: [고객 응답]

**Q5. [지불 의향/가치 인식 질문]**
- A: [고객 응답]

[고객 2-10 동일한 형식으로 계속]

## 주요 인사이트

### Pain Points (고객 불편사항)
1. [Pain Point 1]: [설명]
2. [Pain Point 2]: [설명]
3. [Pain Point 3]: [설명]

### Needs (고객 니즈)
1. [Need 1]: [설명]
2. [Need 2]: [설명]
3. [Need 3]: [설명]

### 기대 가치
- [고객들이 기대하는 가치 1]
- [고객들이 기대하는 가치 2]
- [고객들이 기대하는 가치 3]

### 핵심 인용구
> "[고객의 인상적인 발언 1]" - 고객 A

> "[고객의 인상적인 발언 2]" - 고객 B

---

# 2. 고객 관찰 결과

## 관찰 개요
- **관찰 목적**: [목적]
- **관찰 기간**: [기간]
- **관찰 대상**: [대상]
- **관찰 방법**: 현장 관찰, 맥락적 조사(Contextual Inquiry)

## 관찰 일정

| 관찰일시 | 관찰장소 | 관찰자 | 고객명 | 고객프로필 |
|---------|---------|--------|--------|-----------|
| [일시] | [장소] | [관찰자] | [가명] | [프로필] |
| [5-10명 정도의 관찰 대상자 나열] |

## 관찰 결과

| 사용 서비스/제품 | 관찰 상황 | 관찰 내용 |
|-----------------|---------|----------|
| [서비스/제품] | [상황] | [고객의 행동, 어려움, 특이사항] |
| [5-10개의 관찰 결과 나열] |

## Pain Point와 Needs 분석

| Pain Point | Needs |
|-----------|-------|
| [관찰된 문제점 1] | [도출된 니즈 1] |
| [관찰된 문제점 2] | [도출된 니즈 2] |
| [관찰된 문제점 3] | [도출된 니즈 3] |
| [5-10개 나열] |

## 행동 패턴 분석

### 패턴 1: [패턴명]
- **설명**: [패턴 설명]
- **빈도**: [얼마나 자주 관찰되었는지]
- **시사점**: [이 패턴이 주는 의미]

### 패턴 2: [패턴명]
[동일한 형식]

### 패턴 3: [패턴명]
[동일한 형식]

## 특이사항

| 고객 | 특이사항 |
|------|----------|
| [고객명] | [특별히 주목할 만한 관찰 내용] |
| [5-10개 나열] |

---

# 3. 고객 체험 결과

## 체험 개요
- **체험 목적**: [목적]
- **체험 기간**: [기간]
- **체험 대상**: [대상 서비스/제품]
- **체험 방법**: 실제 서비스/제품 사용 체험

## 체험 일정 및 내용

| 날짜 | 서비스/제품명 | 구매/이용 내역 | 배송 및 포장 |
|------|-------------|---------------|-------------|
| [날짜] | [서비스명] | [내역 및 가격] | [배송 상태, 포장 상태] |
| [5-10개의 체험 기록 나열] |

## 체험 세부 평가

### 서비스/제품 품질

| 서비스/제품 | 품질 평가 |
|-----------|----------|
| [서비스명 1] | [품질, 만족도, 특이사항] |
| [5-10개 나열] |

### 고객 서비스 경험

| 고객 서비스 항목 | 경험 내용 |
|----------------|----------|
| [문의/요청 사항] | [응대 품질, 해결 과정, 만족도] |
| [5-10개 나열] |

## 사용 후기 및 만족도

| 서비스/제품 | 사용 후기 | 만족도 (5점 만점) | 향후 이용 의향 |
|-----------|-----------|------------------|---------------|
| [서비스명 1] | [장점, 단점, 개선점] | [점수] | [계속/중단/보류] |
| [5-10개 나열] |

## 구독/이용 관리 경험

| 기능 | 경험 내용 |
|------|----------|
| 가입/구독 절차 | [경험 및 평가] |
| 결제 관리 | [경험 및 평가] |
| 일정 변경 | [경험 및 평가] |
| 해지/환불 | [경험 및 평가] |
| 고객 지원 | [경험 및 평가] |

## 한줄 총평

| 서비스/제품 | 한줄 총평 |
|-----------|-----------|
| [서비스명 1] | [핵심 가치와 경험 요약] |
| [5-10개 나열] |

---

# 종합 인사이트

## 1. 주요 발견 사항
1. **[발견 1]**: [설명]
2. **[발견 2]**: [설명]
3. **[발견 3]**: [설명]

## 2. 고객 여정의 주요 Pain Points
- **[단계 1]**: [문제점]
- **[단계 2]**: [문제점]
- **[단계 3]**: [문제점]

## 3. 개선 기회 영역
1. **[기회 영역 1]**: [설명 및 잠재적 영향]
2. **[기회 영역 2]**: [설명 및 잠재적 영향]
3. **[기회 영역 3]**: [설명 및 잠재적 영향]

## 4. 핵심 고객 니즈 우선순위
1. [최우선 니즈]
2. [2순위 니즈]
3. [3순위 니즈]

## 5. Journey Map 작성을 위한 권장사항
- [권장사항 1]
- [권장사항 2]
- [권장사항 3]

---

**중요**:
- 각 조사 결과는 구체적이고 현실적이어야 합니다
- 실제 고객의 언어와 표현을 사용하세요
- 정성적 데이터와 정량적 데이터를 균형있게 제시하세요
- Journey Map 작성에 직접 활용될 수 있도록 상세하게 작성하세요
"""

    async def execute(self, context: Dict[str, Any]) -> Dict[str, Any]:
        """고객 경험 조사 실행"""
        try:
            if not self.validate_context(context, ["mvp_topic", "target_customer"]):
                return self.format_error("Missing required context")

            if not await self.pre_execute(context):
                return self.format_error("Pre-execution validation failed")

            prompt = self.get_prompt_template(context)
            response = await self.call_claude(prompt, max_tokens=8000)

            result = self.format_output(
                content=response,
                metadata={
                    "research_methods": ["interview", "observation", "experience"],
                    "purpose": "journey_map_preparation"
                }
            )

            return await self.post_execute(result)

        except Exception as e:
            return self.format_error(f"Error in Customer Experience agent: {str(e)}")
